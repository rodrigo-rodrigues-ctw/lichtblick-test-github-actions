name: Release Sync (main -> develop)

on:
  workflow_dispatch:
  release:
    types: [released]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get new version
        id: get_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      # - name: Create sync branch and merge
      #   run: |
      #     git fetch origin develop
      #     BRANCH_NAME="sync/main-to-develop-${{ env.version }}"
      #     git checkout -b $BRANCH_NAME origin/develop
      #     git merge origin/main --no-ff -m "chore: sync main into develop after release"
      #     git push origin $BRANCH_NAME
      #     echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      # - name: Debug version
      #   run: echo "Version is ${{ env.version }}"

      # - name: Create Pull Request
      #   run: |
      #       gh pr create \
      #         -B develop \
      #         -H ${{ env.BRANCH_NAME }} \
      #         --title "Release ${{ env.version }} Merge main into develop" \
      #         --body "This PR syncs changes from \`main\` into \`develop\` after release **${{ env.version }}**.

      #         Please review the changes before merging.

      #         **Auto-generated by GitHub Actions**"
      #   env:
      #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create sync branch and merge
        run: |
          git fetch origin develop
          BRANCH_NAME="sync/main-to-develop-${{ env.version }}"
          git checkout -b $BRANCH_NAME origin/develop
          git merge origin/main --no-ff -m "chore: sync main into develop after release" || true
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "CONFLICT=true" >> $GITHUB_ENV
          fi
          git add .
          git commit -m "chore: sync main into develop after release (conflicts to resolve)" || true
          git push origin $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      - name: Debug version
        run: echo "Version is ${{ env.version }}"

      - name: Create Pull Request
        run: |
            CONFLICT_NOTE=""
            if [ "${{ env.CONFLICT }}" == "true" ]; then
              CONFLICT_NOTE="⚠️ **This PR has merge conflicts that need to be resolved manually.**"$'\n\n'
            fi
            gh pr create \
              -B develop \
              -H ${{ env.BRANCH_NAME }} \
<<<<<<< HEAD
              --title "Release ${{ env.version }} Merge main into develop" \
              --body "${CONFLICT_NOTE}This PR syncs changes from \`main\` into \`develop\` after release **${{ env.version }}**.
=======
              --title 'Release ${{ steps.get_version.outputs.version }} Merge main with develop' \
              --body "This PR syncs changes from \`main\` into \`develop\` after release **${{ steps.get_version.outputs.version }}**.
>>>>>>> origin/main

                Please review the changes before merging.

                **Auto-generated by GitHub Actions**"
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
